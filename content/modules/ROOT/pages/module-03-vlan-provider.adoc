= Connexion de Machines Virtuelles aux Réseaux d'Entreprise dans OpenShift Virtualization

== Introduction

Nous déplaçons une application existante vers OpenShift Virtualization. Le front-end web peut utiliser le réseau des pods, mais la **base de données backend** doit résider sur le **réseau d'entreprise** existant pour des raisons de sécurité et de conformité.

Ce module explique comment OpenShift Virtualization comble le fossé entre Kubernetes et les réseaux traditionnels. Vous observerez la **NodeNetworkConfigurationPolicy (NNCP)** qui prépare les nœuds, créerez une **NetworkAttachmentDefinition (NAD)** pour définir le réseau, et enfin, vous lancerez une VM connectée à la fois au réseau des pods et au réseau d'entreprise.

== Comprendre et Observer la Configuration Réseau des Nœuds (NNCP)

Avant de créer un réseau pour notre VM, les *nœuds* du cluster doivent être préparés physiquement via la **NodeNetworkConfigurationPolicy (NNCP)**.

Pensez à la NNCP comme à la **plomberie de bas niveau**. C'est une tâche d'administration qui indique aux nœuds workers comment configurer leurs interfaces réseau. Pour notre scénario, un administrateur a déjà créé une NNCP qui :

1.  Sélectionne les nœuds workers.
2.  Prend une interface réseau physique (par ex., `ens2`).
3.  Crée un nouveau **pont Linux** (par ex., `br1`) et y attache cette interface physique.

Ce pont `br1` est maintenant connecté au réseau d'entreprise. Tout le trafic des VM destiné à ce réseau passera par ce pont. Observons cette configuration existante.

. Dans la console OpenShift, changez votre perspective en *Administrator* (si ce n'est pas déjà fait).
. Dans le menu de navigation de gauche, cliquez sur *Administration* -> *CustomResourceDefinitions*.
. Dans la boîte *Filtrer par nom* (Filter by name), tapez `NodeNetworkConfigurationPolicy` et cliquez sur le nom résultant.
+
image::module-02-vlan/02-search-nncp.png[title="Rechercher la NNCP", link=self, window=blank, width=100%]
+
. Cliquez sur l'onglet *Instances* pour voir toutes les politiques actuellement définies.
. Vous devriez voir une politique nommée `br-flat`. Cliquez dessus.
. Cliquez sur l'onglet *YAML* pour voir la définition de la politique.
+
image::module-02-vlan/03-nncp-yaml-view.png[title="Vue YAML de la NNCP", link=self, window=blank, width=100%]
+
. Observez le `desiredState`. Il décrit la configuration réseau qu'OpenShift appliquera sur les nœuds. Il ressemblera à ceci :

[source,yaml]
----
spec:
  desiredState:
    interfaces:
      - name: br1 <1>
        description: Linux bridge for enterprise traffic
        type: linux-bridge
        state: up
        bridge:
          options:
            stp:
              enabled: false
          port:
            - name: ens2 <2>
  nodeSelector:
    node-role.kubernetes.io/worker: "" <3>
----
<1> Définit le nouveau pont Linux nommé `br1`. C'est le nom dont nous aurons besoin pour la prochaine étape.
<2> Attache la carte réseau physique (NIC) `ens2` du nœud au pont `br1`.
<3> Cette politique est appliquée à tous les nœuds ayant le rôle "worker".

Maintenant que nous avons confirmé que la "plomberie" est en place sur les nœuds, nous pouvons créer un réseau qui l' *utilise*.

[[nad-create]]
== Créer la Network Attachment Definition (NAD)

La NNCP a préparé les *nœuds*, mais elle n'a pas créé de *réseau* que nos pods ou VM peuvent utiliser. Pour cela, nous avons besoin d'une **NetworkAttachmentDefinition (NAD)**.

Pensez à la NAD comme à l'**"invitation réseau"**. C'est une ressource limitée à un espace de noms (namespace-scoped) qui définit un réseau spécifique. Notre NAD dira : "Je crée un réseau appelé 'corp-network' qui utilise le type `cnv-bridge` et se connecte au pont `br1` (défini dans la NNCP)."

. Dans le menu de navigation de gauche, cliquez sur *Networking* -> *NetworkAttachmentDefinitions*.
. Dans la liste déroulante *Project* en haut, sélectionnez un projet où vous souhaitez que votre VM réside. Pour ce laboratoire, utilisons le projet *default*, ou créez-en un nommé `backend-vms`.
. Cliquez sur le bouton *Create Network Attachment Definition*.
+
image::module-02-vlan/04-create-nad-button.png[title="Bouton Create NAD", link=self, window=blank, width=100%]
+
. Remplissez le formulaire avec les détails suivants :
    * *Name:* `corp-network`
    * *Description:* `Réseau d'entreprise pour les VM backend`
    * *Network Type:* Sélectionnez `CNV Linux bridge` dans la liste déroulante. C'est le type utilisé par OpenShift Virtualization.
+
. Une fois le type sélectionné, le formulaire se mettra à jour. Remplissez le nouveau champ :
    * *Bridge Name:* `br1` (Cela *doit* correspondre au nom du pont de la NNCP que nous avons observée).
+
NOTE: C'est également ici que vous pourriez spécifier un *VLAN Tag Number* si votre réseau l'exigeait. Pour cet exercice, nous n'en avons pas besoin et laissons ce champ vide.

+
image::module-02-vlan/05-nad-form-fill-no-vlan.png[title="Remplir le formulaire NAD sans VLAN", link=self, window=blank, width=100%]
+
NOTE: Nous laissons *IP Address Management* (Gestion des adresses IP) vide. La VM obtiendra une IP soit du serveur DHCP de l'entreprise sur ce réseau, soit nous configurerons une IP statique *depuis l'intérieur* du système d'exploitation invité.

. Cliquez sur le bouton *Create*.
. Vous verrez votre nouvelle NAD `corp-network` dans la liste. Si vous cliquez dessus et allez dans l'onglet *YAML*, vous verrez la configuration résultante :

[source,yaml]
----
apiVersion: k8s.cni.cncf.io/v1
kind: NetworkAttachmentDefinition
metadata:
  name: corp-network
  namespace: default
spec:
  config: '{
    "cniVersion": "0.3.1",
    "name": "corp-network",
    "type": "cnv-bridge", <1>
    "bridge": "br1", <2>
    "ipam": {} <3>
  }'
----
<1> Le type de plugin réseau.
<2> Le pont Linux sur le nœud à utiliser.
<3> Le bloc IPAM vide, confirmant qu'aucune attribution d'IP n'est faite côté cluster.

[[vm-create]]
== Créer une VM avec Plusieurs Interfaces Réseau

Nous sommes prêts à créer notre VM de base de données. Nous l'attacherons à *deux* réseaux :
1.  Le **Réseau des Pods** (Pod Network) par défaut (pour la connectivité de base au cluster, SSH, etc.).
2.  Notre nouveau réseau **corp-network** (pour le trafic sécurisé de la base de données).

. Dans le menu de navigation de gauche, basculez vers la perspective *Virtualization*.
. Cliquez sur *Virtualization* -> *VirtualMachines*.
. Assurez-vous d'être dans le même projet où vous avez créé la NAD (par ex., *default*).
. Cliquez sur *Create* -> *VirtualMachine*.
. Dans l'assistant, remplissez la section *General* :
    * *Name:* `finance-db-01`
    * *Operating System:* Sélectionnez une image RHEL ou Fedora.
    * *Flavor:* Sélectionnez `small` ou `medium`.
. Cliquez sur l'onglet *Networking*.
+
image::module-02-vlan/06-vm-wizard-networking.png[title="Onglet Networking de l'assistant VM", link=self, window=blank, width=100%]
+
. Vous verrez une interface déjà présente, connectée au *Pod Networking*. C'est la valeur par défaut.
. Cliquez sur le bouton *Add Network Interface*.
. Une nouvelle fenêtre modale apparaîtra. Configurez la seconde interface :
    * *Name:* `nic-1-corpnet` (C'est juste un nom convivial).
    * *Model:* `virtio` (C'est la valeur par défaut et recommandée).
    * *Network:* Cliquez sur la liste déroulante et sélectionnez notre NAD **corp-network**.
    * *Type:* `Bridge`
    * *MAC Address:* (Laissez vide pour une génération automatique).
+
image::module-02-vlan/07-vm-add-nic-modal-no-vlan.png[title="Modale d'ajout d'interface réseau", link=self, window=blank, width=100%]
+
. Cliquez sur le bouton *Add* dans la modale.
. Vous devriez maintenant voir *deux* interfaces réseau listées pour votre VM.
+
image::module-02-vlan/08-vm-two-nics-no-vlan.png[title="VM avec deux NICs", link=self, window=blank, width=100%]
+
. Cliquez sur le bouton *Create VirtualMachine* en bas et attendez que la VM démarre.

[[vm-verify]]
== Vérifier la Configuration Réseau de la VM

Confirmons que notre VM dispose des deux connexions réseau.

. Cliquez sur la VM `finance-db-01` que vous venez de créer.
. Allez à l'onglet *Network Interfaces*.
. Vous verrez les deux interfaces listées :
    * L'interface `Pod Networking` affichera une adresse IP attribuée par le cluster (par ex., `10.131.x.x`).
    * L'interface `corp-network` n'affichera *pas* d'adresse IP. C'est normal, car OpenShift ne gère pas son IP.
+
image::module-02-vlan/09-vm-details-nic-tab-no-vlan.png[title="NICs dans les détails de la VM", link=self, window=blank, width=100%]
+
. Maintenant, vérifions à l'intérieur du système d'exploitation invité (guest OS).
. Cliquez sur l'onglet *Console* et connectez-vous à la VM.
. Une fois connecté, lancez la commande `ip a` pour lister toutes les interfaces réseau.
. Vous verrez (au moins) deux interfaces, probablement `eth0` et `eth1` :
    * `eth0`: Ce sera la première NIC, connectée au réseau Pod. Elle aura l'adresse IP du cluster (par ex., `10.131.5.20`).
    * `eth1`: Ce sera la seconde NIC, connectée à notre réseau d'entreprise. Elle n'aura pas d'IP *ou* aura une IP provenant de votre serveur DHCP d'entreprise.
+
[source,sh]
----
$ ip a
...
2: eth0: <BROADCAST,MULTICAST,UP,LOWER_UP> ...
    inet 10.131.5.20/23 ...
...
3: eth1: <BROADCAST,MULTICAST,UP,LOWER_UP> ...
    <pas d'adresse IP, ou une venant du DHCP de l'entreprise>
----
+
. Cela confirme que la VM est connectée avec succès au réseau d'entreprise. À partir de là, vous pouvez vous connecter à la VM et configurer une IP statique sur l'interface `eth1` (par ex., `192.168.100.50`) pour communiquer de manière sécurisée avec d'autres services sur ce réseau.

== Résumé

Dans ce module, vous avez mis en place une connectivité réseau hybride pour une Machine Virtuelle. Vous avez appris la différence critique entre les deux composants qui rendent cela possible :

* **NodeNetworkConfigurationPolicy (NNCP):** La ressource de bas niveau, gérée par l'administrateur du cluster, qui configure le matériel physique du *nœud*, en créant un pont Linux (`br1`) sur une NIC physique.
* **NetworkAttachmentDefinition (NAD):** La ressource de haut niveau, limitée à un espace de noms, qui définit un *réseau utilisable* en pointant vers le pont de la NNCP (`br1`).