= Connexion de Machines Virtuelles à des VLAN dans OpenShift Virtualization

== Introduction

Notre parcours continue avec une tâche de migration critique. Nous déplaçons une application existante (legacy) à plusieurs niveaux vers OpenShift Virtualization. Bien que le front-end web puisse résider sur le réseau des pods standard, la **base de données backend** de l'application est soumise à des règles de sécurité et de conformité strictes. Elle *doit* résider sur le **VLAN 100** d'entreprise existant pour communiquer avec d'autres services protégés dans le centre de données. Nous ne pouvons pas simplement la placer sur le réseau par défaut du cluster.

Ce scénario présente un défi courant : comment combler le fossé entre la mise en réseau moderne de Kubernetes et les réseaux de centres de données traditionnels segmentés par VLAN.

Dans ce module, vous apprendrez comment OpenShift Virtualization utilise un système en deux parties pour résoudre ce problème. D'abord, vous observerez la **NodeNetworkConfigurationPolicy (NNCP)**, qui indique aux *nœuds* du cluster comment configurer leur matériel physique. Ensuite, vous créerez une **NetworkAttachmentDefinition (NAD)**, qui définit un *réseau utilisable* pour nos VM. Enfin, vous lancerez une nouvelle machine virtuelle avec deux cartes réseau : une sur le réseau des pods par défaut et une connectée directement à notre VLAN sécurisé.

== Comprendre et Observer la Configuration Réseau des Nœuds (NNCP)

Avant de pouvoir créer un réseau pour notre VM, les *nœuds* du cluster doivent être préparés physiquement. C'est le rôle de la **NodeNetworkConfigurationPolicy (NNCP)**.

Pensez à la NNCP comme à la **plomberie de bas niveau**. C'est une tâche d'administration du cluster, généralement effectuée une seule fois, qui indique à des nœuds spécifiques (comme nos workers) comment configurer leurs interfaces réseau. Pour notre scénario VLAN, un administrateur de cluster a déjà créé une NNCP qui :

1.  Sélectionne les nœuds workers.
2.  Prend une interface réseau physique (par ex., `ens2`).
3.  Crée un nouveau **pont Linux** (par ex., `br1`) et y attache cette interface physique.

Ce pont `br1` est maintenant "conscient des VLAN" (VLAN-aware) et connecté au réseau d'entreprise. Tout le trafic des VM destiné à un VLAN passera par ce pont. Observons cette configuration existante.

. Dans la console OpenShift, changez votre perspective en *Administrator* (si ce n'est pas déjà fait).
. Dans le menu de navigation de gauche, cliquez sur *Administration* -> *CustomResourceDefinitions*.
. Dans la boîte *Filtrer par nom* (Filter by name), tapez `NodeNetworkConfigurationPolicy` et cliquez sur le nom résultant.
+
image::module-02-vlan/02-search-nncp.png[title="Rechercher la NNCP", link=self, window=blank, width=100%]
+
. Cliquez sur l'onglet *Instances* pour voir toutes les politiques actuellement définies.
. Vous devriez voir une politique nommée `br-flat`. Cliquez dessus.
. Cliquez sur l'onglet *YAML* pour voir la définition de la politique.
+
image::module-02-vlan/03-nncp-yaml-view.png[title="Vue YAML de la NNCP", link=self, window=blank, width=100%]
+
. Observez le `desiredState`. Il décrit la configuration réseau qu'OpenShift appliquera sur les nœuds. Il ressemblera à ceci :

[source,yaml]
----
spec:
  desiredState:
    interfaces:
      - name: br1 <1>
        description: Linux bridge for VLAN traffic
        type: linux-bridge
        state: up
        bridge:
          options:
            stp:
              enabled: false
          port:
            - name: ens2 <2>
  nodeSelector:
    node-role.kubernetes.io/worker: "" <3>
----
<1> Définit le nouveau pont Linux nommé `br1`. C'est le nom dont nous aurons besoin pour la prochaine étape.
<2> Attache la carte réseau physique (NIC) `ens2` du nœud au pont `br1`.
<3> Cette politique est appliquée à tous les nœuds ayant le rôle "worker".

Maintenant que nous avons confirmé que la "plomberie" est en place sur les nœuds, nous pouvons créer un réseau qui l' *utilise*.

[[nad-create]]
== Créer la Network Attachment Definition (NAD)

La NNCP a préparé les *nœuds*, mais elle n'a pas créé de *réseau* que nos pods ou VM peuvent utiliser. Pour cela, nous avons besoin d'une **NetworkAttachmentDefinition (NAD)**.

Pensez à la NAD comme à l'**"invitation réseau"**. C'est une ressource limitée à un espace de noms (namespace-scoped) qui définit un réseau spécifique. Notre NAD dira : "Je crée un réseau appelé 'vlan-100-finance' qui utilise le type `cnv-bridge`, se connecte au pont `br1` (de la