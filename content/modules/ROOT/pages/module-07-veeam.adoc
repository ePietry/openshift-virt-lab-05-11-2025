= Sauvegarde et Restauration de VM avec Veeam Kasten

== Introduction

Dans un environnement de production, la capacité à sauvegarder et restaurer rapidement des machines virtuelles est cruciale. OpenShift Virtualization, étant *cloud-native*, s'intègre avec des solutions de protection de données modernes comme *Veeam Kasten K10*.

Kasten traite les applications, y compris les VM, comme une unité atomique, sauvegardant non seulement les disques (PVCs) mais aussi la configuration (les objets Kubernetes/OpenShift qui définissent la VM).

. Dans ce module, nous allons :
* Créer une VM de test et y ajouter un fichier.
* Sauvegarder cette VM à l'aide d'une politique Kasten.
* Simuler un sinistre en supprimant la VM.
* Restaurer la VM à partir de la sauvegarde.
* Vérifier que la VM est revenue à son état précédent, y compris le fichier de test.

== Préparation de la Machine Virtuelle de Test

Pour tester le cycle de vie de la sauvegarde et de la restauration, nous avons besoin d'une VM avec un état spécifique (un fichier de test).

. Naviguez vers la vue *Virtualization*. Assurez-vous d'être dans votre *project* (`projet-X`).

. Cliquez sur *Create VirtualMachine* et sélectionnez *From template*.

. Sélectionnez le *template* *Fedora VM*.
+
image::2025_spring/kasten/1.png[link=self, window=blank, width=100%]

. Changez le nom en **fedora-kasten-test** et cliquez sur *Quick create VirtualMachine*.

. Attendez que la VM passe au statut *Running*.

. Sélectionnez la VM *fedora-kasten-test* et cliquez sur l'onglet *Console*.

. Connectez-vous à la VM en utilisant les *Guest login credentials* fournis.

. Une fois connecté, créez un fichier de test vide à la racine du répertoire personnel de l'utilisateur.
+
[source,sh,role=execute]
----
touch test.txt
----

. Vérifiez que le fichier existe bien en listant le contenu du répertoire.
+
[source,sh,role=execute]
----
ls
----
+
Vous devriez voir `test.txt` apparaître dans la liste. Laissez cette VM en cours d'exécution.
+
image::2025_spring/kasten/2.png[link=self, window=blank, width=100%]

== Accès à la Console Kasten K10

La console Kasten est l'interface web où nous gérerons les politiques de sauvegarde et les actions de restauration.

. Dans la console OpenShift, passez à la vue *Administrator*.

. Dans le menu de gauche, naviguez vers *Networking* -> *Routes*.

. Assurez-vous que le *Project* sélectionné est **kasten-io** (ou le projet où Kasten est installé dans votre lab).

. Vous devriez voir une route nommée *k10-dashboard* (ou similaire). Cliquez sur l'URL dans la colonne *Location*.
+
image::2025_spring/module-08-kasten/03_kasten_route.png[link=self, window=blank, width=100%]

. Une nouvelle fenêtre s'ouvrira avec le tableau de bord Kasten K10. Il se peut qu'on vous demande de vous authentifier (généralement via OpenShift).

== Création et Exécution d'une Politique de Sauvegarde

Nous allons maintenant créer une "politique" (Policy) qui dit à Kasten quoi sauvegarder et comment.

. Dans le tableau de bord Kasten, cliquez sur *Policies* dans la barre de navigation.

. Cliquez sur le bouton *Create New Policy*.

. Remplissez le formulaire pour notre politique de sauvegarde :
    * *Name:* `backup-vm-projet-x`
    * *Action:* Laissez à *Snapshot*.
    * Laissez les autres options par défaut (Fréquence, etc.).
    * Dans la section *Select Applications*, choisissez *By Name*.
    * Dans le *dropdown* *Applications*, trouvez et sélectionnez **fedora-kasten-test**. (Kasten voit la VM comme une "Application").
+
image::2025_spring/module-08-kasten/04_kasten_policy.png[link=self, window=blank, width=100%]

. Cliquez sur *Create Policy*.

. La politique est maintenant créée, mais elle n'a pas encore été exécutée. Sur la ligne de votre nouvelle politique (`backup-vm-projet-x`), cliquez sur l'icône *Run Once* (l'icône "play").
+
image::2025_spring/module-08-kasten/05_kasten_run_once.png[link=self, window=blank, width=100%]

. Confirmez en cliquant sur *Run Policy* dans la fenêtre contextuelle.

. Cliquez sur *Dashboard* dans le menu principal de Kasten. Vous verrez un job de sauvegarde en cours (*Running*). Attendez quelques instants jusqu'à ce que le statut du job passe à *Succeeded*.
+
image::2025_spring/module-08-kasten/06_kasten_backup_success.png[link=self, window=blank, width=100%]

. Notre VM est maintenant sauvegardée.

== Simulation d'un Sinistre (Suppression de la VM)

Il est temps de simuler une suppression accidentelle de notre machine virtuelle.

. Retournez à la console OpenShift et à la vue *Virtualization*.

. Assurez-vous d'être dans votre *project* (`projet-X`).

. Sélectionnez la VM *fedora-kasten-test*.

. Cliquez sur le menu *Actions* (dans le coin supérieur droit) et sélectionnez *Delete VirtualMachine*.
+
image::2025_spring/module-08-kasten/07_delete_vm.png[link=self, window=blank, width=100%]

. Confirmez la suppression en tapant le nom de la VM et en cliquant sur *Delete*.

. Attendez que la VM disparaisse de la liste. Notre VM et son fichier `test.txt` ont disparu.

== Restauration de la Machine Virtuelle

Utilisons maintenant Kasten pour restaurer notre VM à partir du point de sauvegarde (snapshot).

. Retournez au tableau de bord Kasten K10.

. Cliquez sur *Applications* dans le menu. Vous devriez toujours voir *fedora-kasten-test* dans la liste (marquée comme "Removed" ou avec un point rouge), car elle a des points de restauration.

. Cliquez sur le nom de l'application *fedora-kasten-test*.

. Vous verrez une liste de *Restore Points*. Localisez le point de restauration valide que nous avons créé à l'étape précédente (il devrait être marqué *Snapshot*).
+
image::2025_spring/module-08-kasten/08_kasten_restore_point.png[link=self, window=blank, width=100%]

. Cliquez sur l'icône *Restore* sur la même ligne que ce point de restauration.

. Une fenêtre *Restore Application* s'ouvrira. Nous voulons restaurer tout à son état d'origine. Laissez toutes les options par défaut et cliquez sur le bouton *Restore*.

. Vous serez redirigé vers le *Dashboard* où vous pourrez suivre le statut du job de restauration. Attendez que le job passe à *Succeeded*.
+
image::2025_spring/module-08-kasten/09_kasten_restore_success.png[link=self, window=blank, width=100%]

== Vérification de la Restauration

Vérifions si notre VM est revenue et, plus important encore, si son état (le fichier `test.txt`) a été restauré.

. Retournez à la console OpenShift et à la vue *Virtualization*.

. Dans votre *project-X*, vous devriez maintenant voir la VM *fedora-kasten-test* réapparaître. Attendez qu'elle atteigne le statut *Running*.

. Cliquez sur la VM, puis sur l'onglet *Console*.

. Connectez-vous à nouveau à la machine virtuelle (les identifiants devraient être les mêmes).

. Une fois connecté, listez le contenu du répertoire personnel.
+
[source,sh,role=execute]
----
ls
----
+
**Vous devriez voir le fichier `test.txt` !**
+
image::2025_spring/module-08-kasten/10_verify_file_restored.png[link=self, window=blank, width=100%]

. (Optionnel) Vous pouvez maintenant vous déconnecter de la console (Ctrl-D).

== Cleanup

Pour économiser les ressources, veuillez arrêter la VM que nous venons de restaurer.

. Dans la vue *Virtualization*, sélectionnez la VM *fedora-kasten-test*.
. Cliquez sur le bouton *Stop*.

== Conclusion

Félicitations ! Vous avez terminé le cycle complet de protection des données pour une machine virtuelle *cloud-native*.

Nous avons démontré comment Veeam Kasten s'intègre à OpenShift Virtualization pour sauvegarder non seulement le disque d'une VM, mais aussi son état et sa configuration. Nous avons simulé un sinistre en supprimant la VM, puis nous l'avons restaurée avec succès à son état exact, y compris le fichier de test que nous avions créé. Cela montre la puissance de la gestion des applications *stateful* (qui ont un état) dans OpenShift.
```